---
import { useState } from 'preact/hooks';
import Flashcard from './Flashcard.astro';
import './InteractivePyramid.css';

// Definiendo los niveles de la pirámide
const pyramidLevels = [
  {
    id: 1,
    title: "Business Planning and Logistics",
    description: "La herramienta a usar es el ERP (Enterprise Resource Planning). Este nivel se encarga de la planificación estratégica, gestión de recursos empresariales, finanzas, cadena de suministro y logística a nivel corporativo.",
    area: "top"
  },
  {
    id: 2,
    title: "Manufacturing Operations Management",
    description: "Sistemas MES (Manufacturing Execution System). Este nivel gestiona las operaciones de producción, programación, ejecución, seguimiento y documentación de los procesos de fabricación.",
    area: "upper-middle"
  },
  {
    id: 3,
    title: "Monitoring & Supervision",
    description: "Aquí es donde se encuentran los sistemas SCADA (System Control And Data Acquisition) y HMI (Human Machine Interface). Este nivel supervisa y controla los procesos en tiempo real, proporcionando interfaces para operadores.",
    area: "middle"
  },
  {
    id: 4,
    title: "Sensing & Manipulation",
    description: "Donde los Controladores Industriales (PLCs y PACs) manejan las máquinas. Este nivel incluye la automatización de procesos específicos, control de dispositivos y adquisición de datos de sensores.",
    area: "lower-middle"
  },
  {
    id: 5,
    title: "Production Process",
    description: "También llamado nivel de planta o Floor level. Este nivel incluye las máquinas, sensores, actuadores y dispositivos físicos que realizan el trabajo de producción real.",
    area: "bottom"
  }
];

// flashcards que se pueden clickear
const clickableAreas = [
  { id: 1, coords: "50,10,150,60", shape: "rect", levelId: 1 },
  { id: 2, coords: "75,60,125,110", shape: "rect", levelId: 2 },
  { id: 3, coords: "100,110,150,160", shape: "rect", levelId: 3 },
  { id: 4, coords: "125,160,175,210", shape: "rect", levelId: 4 },
  { id: 5, coords: "150,210,200,260", shape: "rect", levelId: 5 }
];

export default function InteractivePyramid(){

	const [activeFlashcard, setActiveFlashcard] = useState(null);

	const openFlashcard = (levelId) => {
	  setActiveFlashcard(levelId);
	};

	const closeFlashcard = () => {
	  setActiveFlashcard(null);
	};

// obtener el texto de cada flashcard
const activeLevel = pyramidLevels.find(level => level.id === activeFlashcard);
return (
<div class="Pyramid">
  <div class="pyramid-container">
    <!-- Imagen con las flashcards -->
    <div class="pyramid-image-wrapper">
      <img 
        src="../images/PiramideISA95.png" 
        alt="Pirámide de la Automatización de Acuerdo a la norma ISA-95" 
        class="pyramid-image"
        use:map
      />
      
      <!-- superposición de las flashcards con la imagen -->
      <div class="clickable-areas">
        {clickableAreas.map(area => (
          <button
            class={`clickable-area ${area.shape}`}
            style={`
              left: ${area.coords.split(',')[0]}px;
              top: ${area.coords.split(',')[1]}px;
              width: ${parseInt(area.coords.split(',')[2]) - parseInt(area.coords.split(',')[0])}px;
              height: ${parseInt(area.coords.split(',')[3]) - parseInt(area.coords.split(',')[1])}px;
            `}
            onClick={() => openFlashcard(area.levelId)}
            aria-label={`Learn about ${pyramidLevels.find(l => l.id === area.levelId)?.title}`}
          />
        ))}
      </div>
    </div>
    
    <!-- etiquetas de los niveles para referencia -->
    <div class="pyramid-labels">
      {pyramidLevels.map((level, index) => (
        <div class="pyramid-label" key={level.id}>
          <span class="label-number">{level.id}.</span>
          <span class="label-text">{level.title}</span>
          <button 
            class="label-button"
            onClick={() => openFlashcard(level.id)}
          >
            Más info
          </button>
        </div>
      ))}
    </div>
  </div>
  
  <!-- Flashcard component -->
  {activeLevel && (
    <Flashcard 
      title={activeLevel.title}
      description={activeLevel.description}
      isVisible={true}
      onClose={closeFlashcard}
    />
  )}
</div>
);
}

<script>
  // interactividad con javascript
  if (typeof window !== 'undefined') {
    // efecto cuando el mouse pase por las áreas
    document.addEventListener('DOMContentLoaded', () => {
      const areas = document.querySelectorAll('.clickable-area');
      
      areas.forEach(area => {
        area.addEventListener('mouseenter', (e) => {
          e.target.style.backgroundColor = 'rgba(59, 130, 246, 0.15)';
          e.target.style.borderColor = 'rgba(59, 130, 246, 0.7)';
        });
        
        area.addEventListener('mouseleave', (e) => {
          e.target.style.backgroundColor = 'transparent';
          e.target.style.borderColor = 'rgba(59, 130, 246, 0)';
        });
      });
    });
  }
</script>
---
